{% extends 'admin/index.html' %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
crossorigin=""/>
 <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
   integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
   crossorigin="">
</script>
{% endblock %}

{% block body %}

<h1>Maps</h1>

<h2>Floors</h2>

<p>Select an existing floor</p>

<div>
    <h2>Find a floor</h2>
    <select onchange="if (this.value) window.location.href=this.value">
        <option selected>Choose a floor</option>
        {% for floor in floors %}
        <option value="/admin/maps?floor={{ floor.id }}">{{ floor }}</option>
        {% endfor %}
    </select>
</div>


<!-- Displaying the map only if needed -->
{% if selected_floor is not none %}

{% if selected_room is not none %}
    <h2>{{ selected_floor }} > {{ selected_room }}</h2>
{% else %}
    <h2>{{ selected_floor }}</h2>
{% endif %}

<div id="mapid" style="height: 500px;"></div>

<script>
// create the map
    var map = L.map('mapid', {
        center: [0, 0],
        zoom: 7
    });
    // create the image
    var imageUrl = '/static/images/maps/{{ selected_floor.id }}.svg'
    var imageBounds = [[0, 0], [250, 250]];
    var overlay = L.imageOverlay(imageUrl, imageBounds);
    overlay.addTo(map);
    // zoom the map to the polygon
    map.fitBounds(imageBounds);

    // TODO : iterate over all the rooms to display them on the map
    {% if selected_room is not none %}
        var personRoomX = {{ selected_room.coordinate_x }}
        var personRoomY = {{ selected_room.coordinate_y }}
        L.marker([personRoomX, personRoomY]).addTo(map)
    {% endif %}

    // TODO : use selected_room to focus on a specific room on the map
    var popup = L.popup();
    function onMapClick(e) {
        var httpContent = e.latlng.toString();
        httpContent += "<br />";
        httpContent += "\
                <div>\
            <h3>Select a room</h3>\
            <select onchange=\"if (this.value) window.location.href=this.value\">\
                <option selected>Choose a room</option>\
                {% for room in selected_floor.rooms %}\
                <option value=\"/map/room/{{ room.id }}\">{{ room }}</option>\
                {% endfor %}\
            </select>\
            </div>\
        ";
        httpContent += "<br />";
        httpContent += "<input type='submit'></input>";
        popup
            .setLatLng(e.latlng)
            .setContent(httpContent)
            .openOn(map);
    };

    map.on('click', onMapClick);

</script>
{% endif %}

{% endblock %}
